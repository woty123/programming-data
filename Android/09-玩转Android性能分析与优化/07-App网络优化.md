[国内Top团队大牛带你玩转Android性能分析与优化](https://coding.imooc.com/class/308.html)

# 8 App网络优化

## 8.1 网络优化从哪些纬度开展

对网络优化的正确认识：

- 网络优化维度是多维的、仅仅重视流量是不够的
- 网络流量消耗量需要精确
- 整体均值会掩盖单点问题
- 粗粒度监控不能帮助我们发现、解决深层次问题

网络优化的维度：

- 流量消耗：
  - 一段时间流量消耗的精确度量、网络类型、前后台
  - 监控相关：用户流量消耗均值、异常率（消耗多、次数多、下载文件过大）
  - 对每个请求，完整链路全部监控（Request、Response），主动上报
- 网络请求质量：
  - 用户体验：请求速度、称功率
  - 监控相关：请求时长、业务称功率、失败率、Top失败接口
- 其他
  - 公司成本：带宽、服务器数量、CDN
  - 客户端耗电

网络优化误区：

- 只关注流量消耗，忽略其他维度
- 只关注均值、整体，忽视个体

## 8.2 网络优化工具选择

### Network Profiler

- 显示实时网络活动：发送、接收数据及连接数
- 需要启用高级分析：`run-->Edit Configurations-->app-->Enable Advanced Profiling`
- 只支持 HttpURLConnection 和 OkHttp

### 抓包工具

- Charles
  - 断点功能，拦截修改 Request/Response
  - Map Local：通过 Map Local 模拟接口
  - 弱网环境模拟：`Proxy-->Throttle Settings-->Enable Throttling`
- Fiddler
- Wireshark
- TcpDump

### Stetho

具体参考 [Stetho github](https://github.com/facebook/stetho/)

## 8.3 精准获取流量消耗实战

### 如何判断 App 流量消耗偏高

- 绝对值看不出高低
- 对比竞品，相同 Case 对比流量消耗
- 异常监控超过正常指标

### 测试方案

- 排除别的 app 干扰，设置只允许测试 app 联网
- 可以解决大多数问题，但是线上场景线下可能遇不到

### 线上流量监控

TrafficStats:

- TrafficStats：API8 以上，用于重启以来的流量数据统计
- getUidRxBytes(int uid) 获取指定 uid 的接收流量
- getTotalTxBytes() 获取总发送量
- 无法获取某个时间段内的流量消耗

NetworkStatsManager：

- API23 之后流量统计
- 可获取指定时间段内消耗的流量
- 可获取不同网络类型消耗的流量

### 前台后台流量获取方案

- 难题：线上反馈 App 后台跑流量
- 只获取一个时间段的值不够全面

具体方案：后台定时任务->获取间隔内流量->记录前后台->分别计算->上报 APM 后台->流量治理依据

- 有一定误差，但在可接受范围内

## 8.4 网络请求流量优化实战

使用缓存：

- 服务端返回缓存过期时间

数据增量更新：

- 数据加上版本概念，只传输有变化的数据

数据压缩：

- Post 请求Body 使用 GZip 压缩
- 请求头压缩
- 图片上床之前压缩

优化发送频率和时机：

- 合并网络请求，减少请求次数
- 性能日志上报：批量 + 特定场景上报（比如WIFI时）

图片相关：

- 图片使用策略：优先缩略图

## 8.5 网络请求质量优化实战

### 质量指标

- 网络请求成功率
- 网络请求速度

### DNS 相关

- DNS 被劫持，DNS 解析满
- 方案：使用 HttpDNS（可以使用阿里云DNS解析服务）

### 协议版本升级

- Http2

### 网络请求质量监控

- 可使用 OkHttp 提供的 `EventListener`
- 图片监控：Fresco 提供就了 FrescoTraceListener

### 其他优化

- CDN 优化
- 动态静态分离

## 8.6 网络体系化方案建设

### 线下测试

- 单独针对 APP 抓包
- 侧重点：请求有误、多余、网络切换、弱网、无网测试

### 线下监控

- 服务端监控
- 客户端监控

## 8.7 网络优化模拟面试

1. 在网络方面你们做了哪些监控，建立了哪些指标？
   1. 演进过程，优化背景
   2. 质量监控：请求称功率，每步耗时，状态码
   3. 流量监控：精确统计，前后台
2. 如果有效降低用户流量消耗？
   1. 数据：缓存，增量更新
   2. 上传：压缩
   3. 图片：缩略图，webp
3. 用户反馈消耗流量多这个问题怎么查？
   1. 精准流量获取能力
   2. 所有请求大小及次数监控
   3. 主动预警能力
